# Aura 測試指南

> 包含所有功能測試、一致性測試、性能測試的完整指南

---

## 📋 目錄

1. [快速測試清單](#快速測試清單)
2. [模擬數據測試](#模擬數據測試)
3. [真實設備測試](#真實設備測試)
4. [一致性測試](#一致性測試)
5. [性能測試](#性能測試)
6. [問題排查](#問題排查)

---

## 快速測試清單

### ✅ 基本功能測試（5 分鐘）

- [ ] App 啟動正常
- [ ] 三個 tab 可切換（設備/數據/設置）
- [ ] MindLink 狀態 LED 顯示（紅/黃/綠/橘）
- [ ] 模擬數據開關可切換
- [ ] Console 有 print 輸出

### ✅ UI 測試（5 分鐘）

- [ ] 波形顯示正常
- [ ] 8 段能量卡片顯示
- [ ] 錄製按鈕可用
- [ ] 教學卡片在未連接時顯示
- [ ] 設定按鈕跳轉正確

### ✅ 數據測試（10 分鐘）

- [ ] 模擬數據波形前進正常
- [ ] FFT 分析結果合理
- [ ] 8 波數值總和 ≈ 1.0
- [ ] highAlpha 為主導頻段（0.5-0.6）

---

## 模擬數據測試

### 場景 1: 基本模擬（關閉分析）

#### 操作步驟
1. 運行 App（⌘ + R）
2. 開啟 Console（⌘ + Shift + Y）
3. 切換到「設置」tab
4. 開啟「模擬數據」
5. **確保「模擬分析（Raw→8波）」= OFF**
6. 切換到「數據」tab

#### 預期結果

**Console 輸出**：
```
🔄 [UI] 模擬數據開關切換: true
🎬 [VM] 啟動模擬模式

📤 [SimulatedData] 產生 10 樣本 | 第1個樣本: Int16=-1468 | 範圍: -1468~1276 | Data bytes=20
🔧 [VM] processReceivedData: 收到 20 bytes → 解析為 10 樣本 | 第1個: Int16=-1468
📈 [WF] addSamples values=10 -> total=10

📊 [SimulatedBands] 直接注入: delta=0.0800 highAlpha=0.5200 highBeta=0.2000 lowAlpha=0.0500 lowBeta=0.0300 lowGamma=0.0300 midGamma=0.0100 theta=0.1400

📈 [VM] 更新 bandPowers: delta=0.0800 highAlpha=0.5200 highBeta=0.2000 ...
```

**UI 檢查**：
- [ ] 波形平滑前進
- [ ] 波形速度正常（約 3.9 秒刷新一次）
- [ ] highAlpha 進度條最長（≈ 52%）
- [ ] 無「節流」訊息

**數值記錄**：

| 頻段 | 預期值 | 實際值 | 狀態 |
|------|--------|--------|------|
| delta | 0.08 | _____ | ⬜ |
| theta | 0.14 | _____ | ⬜ |
| lowAlpha | 0.05 | _____ | ⬜ |
| **highAlpha** | **0.52** | **_____** | ⬜ |
| lowBeta | 0.03 | _____ | ⬜ |
| highBeta | 0.20 | _____ | ⬜ |
| lowGamma | 0.03 | _____ | ⬜ |
| midGamma | 0.01 | _____ | ⬜ |

---

### 場景 2: FFT 分析測試（開啟分析）

#### 操作步驟
1. 繼續上一場景
2. 在「設置」tab 開啟「模擬分析（Raw→8波）」
3. 回到「數據」tab
4. 等待 1 秒（讓 FFT 視窗填滿）

#### 預期結果

**Console 輸出**：
```
🔄 [UI] 模擬分析開關切換: true

📤 [SimulatedData] 產生 10 樣本 | ...
🔧 [VM] processReceivedData: 收到 20 bytes → 解析為 10 樣本 | ...
🔬 [VM] 將 10 樣本送入分析器
📈 [WF] addSamples values=10 -> total=510

🧪 [Analyzer] ingest raw: sample=-1468 → normalized=-0.7168 | ring=512/512

📊 [Analyzer] frame#1 mean=0.00123 DC=0.00015 Ny=0.00002 sum=0.45623 delta=0.03654 lowAlpha=0.02134 highAlpha=0.24532 highBeta=0.09123 | 🔬Parseval: 時域=0.45620 頻域=0.45623 誤差=0.01%

➡️  [Analyzer] emit bands (FFT分析): delta=0.0801 highAlpha=0.5378 highBeta=0.1999 lowAlpha=0.0467 lowBeta=0.0324 lowGamma=0.0298 midGamma=0.0090 theta=0.1356

📈 [VM] 更新 bandPowers: delta=0.0801 highAlpha=0.5378 ...
```

**驗證點**：

| 項目 | 標準 | 實際 | 狀態 |
|------|------|------|------|
| Parseval 誤差 | < 1% | _____% | ⬜ |
| highAlpha (FFT) | 0.53-0.55 | _____ | ⬜ |
| 波形速度 | 與場景1相同 | _____ | ⬜ |
| CPU 使用率 | 40-60% | _____% | ⬜ |

---

## 一致性測試

### 目的
驗證「直接模擬 8 波」和「RAW → FFT 分析」的結果一致性

### 測試步驟

1. **記錄場景 1 數值**（直接模擬）
   ```
   highAlpha = _______
   highBeta  = _______
   theta     = _______
   delta     = _______
   ```

2. **記錄場景 2 數值**（FFT 分析）
   ```
   highAlpha = _______
   highBeta  = _______
   theta     = _______
   delta     = _______
   ```

3. **計算差異**
   ```
   Δ highAlpha = |場景2 - 場景1| = _______ (應 < 0.05)
   Δ highBeta  = |場景2 - 場景1| = _______ (應 < 0.05)
   Δ theta     = |場景2 - 場景1| = _______ (應 < 0.05)
   Δ delta     = |場景2 - 場景1| = _______ (應 < 0.05)
   ```

### 通過標準

| 頻段 | 允許誤差 | 判斷 |
|------|---------|------|
| delta | ± 0.02 | ⬜ 通過 / ⬜ 失敗 |
| theta | ± 0.03 | ⬜ 通過 / ⬜ 失敗 |
| lowAlpha | ± 0.03 | ⬜ 通過 / ⬜ 失敗 |
| **highAlpha** | **± 0.05** | ⬜ 通過 / ⬜ 失敗 |
| lowBeta | ± 0.02 | ⬜ 通過 / ⬜ 失敗 |
| highBeta | ± 0.03 | ⬜ 通過 / ⬜ 失敗 |
| lowGamma | ± 0.02 | ⬜ 通過 / ⬜ 失敗 |
| midGamma | ± 0.01 | ⬜ 通過 / ⬜ 失敗 |

---

## 真實設備測試

### 場景 3: Mind Link 連接

#### 操作步驟
1. 確保 Mind Link 已配對（iOS 設定 → 藍牙）
2. 運行 App
3. 切換到「設備」tab
4. 點擊 Mind Link 設備的「連接」按鈕
5. 戴上設備，確保接觸良好

#### 預期結果

**Console 輸出**：
```
🧠 [EA] 狀態變更: connecting
🧠 [EA] 狀態變更: connected
📶 收到 Mind Link 數據: 32 bytes

📥 [EA] 收到資料 bytes=32
📊 [Analyzer] frame#1 ... | 🔬Parseval: 時域=0.523 頻域=0.524 誤差=0.19%

➡️  [Analyzer] emit bands (FFT分析): delta=0.12 highAlpha=0.35 highBeta=0.18 ...
📈 [VM] 更新 bandPowers: delta=0.12 highAlpha=0.35 ...
```

**UI 檢查**：
- [ ] LED 變綠（接觸良好）
- [ ] 教學卡片消失
- [ ] 波形顯示真實腦波
- [ ] 8 波數值合理（根據狀態）

#### 數值合理性檢查

**閉眼放鬆**：
- highAlpha + lowAlpha > 0.4 ✅
- beta 系列 < 0.3 ✅

**睜眼專注**：
- beta 系列 > 0.3 ✅
- alpha 系列下降 ✅

**接觸不良**：
- signalQuality = 200
- LED 變橘色 ⚠️
- 所有頻段劇烈波動

---

## 性能測試

### CPU 使用率測試

**測試方法**：
1. Xcode → Debug Navigator → CPU
2. 觀察不同模式下的 CPU %

**標準**：

| 模式 | 預期 CPU | 實際 CPU | 狀態 |
|------|----------|----------|------|
| 待機（無模擬） | 5-10% | _____% | ⬜ |
| 模擬 Raw（無分析） | 60-80% | _____% | ⬜ |
| 模擬 Raw（有分析） | 40-60% | _____% | ⬜ |
| 真實設備 | 20-40% | _____% | ⬜ |

### 記憶體使用測試

**測試方法**：
1. Xcode → Debug Navigator → Memory
2. 記錄不同操作下的記憶體使用

**標準**：

| 操作 | 預期記憶體 | 實際記憶體 | 狀態 |
|------|-----------|-----------|------|
| 啟動 | < 30 MB | _____ MB | ⬜ |
| 模擬運行 1 分鐘 | < 50 MB | _____ MB | ⬜ |
| 模擬運行 10 分鐘 | < 60 MB | _____ MB | ⬜ |
| 錄製 5 分鐘 | < 80 MB | _____ MB | ⬜ |

### 波形刷新率測試

**測試方法**：
1. 用手機計時器測量波形完整刷新時間
2. 計算刷新率

**計算**：
```
WaveformBuffer maxSamples = 2000
採樣率 = 512 Hz
預期刷新時間 = 2000 / 512 ≈ 3.9 秒

實際測量：_____ 秒
誤差：_____ %
```

**標準**：
- 刷新時間：3.5-4.5 秒 ✅
- 誤差 < 15% ✅

---

## 問題排查

### 問題 1: 無 Console 輸出

**檢查**：
- [ ] Console 已開啟（⌘ + Shift + Y）
- [ ] 選擇正確的設備/模擬器
- [ ] 不是在 Preview 模式（應該用 ⌘ + R）

**解決**：關閉 Preview，重新 Run（⌘ + R）

---

### 問題 2: 波形不動

**檢查 Console**：
```
⏸️ [WF] 節流，跳過此次更新  ← ❌ 不應該出現
```

**解決**：
- 檢查 `WaveformBuffer.swift` 是否移除節流邏輯
- Clean Build（⌘ + Shift + K）
- 重新編譯

---

### 問題 3: highAlpha 不一致

**症狀**：
```
場景 1：highAlpha = 0.52
場景 2：highAlpha = 0.25
差異 = 0.27 > 0.05 ❌
```

**檢查**：
- [ ] `SimulatedDataSource.swift` 基準值已更新
- [ ] FFT 分析器 `useRelative = true`
- [ ] 歸一化正確（總和 = 1.0）

**解決**：檢查 `TECHNICAL_OVERVIEW.md` 中的修復方案

---

### 問題 4: Parseval 誤差過大

**症狀**：
```
🔬Parseval: 時域=0.456 頻域=0.123 誤差=73% ❌
```

**檢查**：
- [ ] FFT 尺度校正（powerBins × 1/N）
- [ ] 雙邊頻譜校正（×2 for bin[1~N/2-1]）
- [ ] Hann 窗校正（× 1/0.375）

**解決**：檢查 `EEGAnalyzer.swift` 的 `processFrame()` 方法

---

### 問題 5: CPU 過高（> 100%）

**可能原因**：
1. Print 輸出過多
2. UI 更新過於頻繁
3. 節流邏輯未移除

**解決**：
- 減少 print 頻率（每 50 或 100 個樣本）
- 檢查 `WaveformBuffer.swift` 節流已移除
- 關閉不必要的 debug 輸出

---

## 📝 測試報告模板

```
測試日期: __________
測試版本: __________
測試設備: __________ (真機/模擬器)

=== 基本功能測試 ===
✅ / ❌ App 啟動
✅ / ❌ UI 顯示
✅ / ❌ 模擬數據
✅ / ❌ 真實設備

=== 一致性測試 ===
highAlpha 差異: _____ (標準 < 0.05)
highBeta 差異: _____ (標準 < 0.05)
Parseval 誤差: _____% (標準 < 1%)

✅ / ❌ 通過

=== 性能測試 ===
CPU (模擬無分析): _____% (標準 60-80%)
CPU (模擬有分析): _____% (標準 40-60%)
記憶體: _____ MB (標準 < 60 MB)
波形刷新: _____ 秒 (標準 3.5-4.5)

✅ / ❌ 通過

=== 問題記錄 ===
1. __________________________
2. __________________________

=== 總結 ===
⬜ 全部通過
⬜ 部分問題
⬜ 測試失敗

備註: __________________________
```

---

**最後更新**: 2025年10月17日  
**版本**: v1.0
